<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iDRAC Controller</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --text-color: #1a1a1a;
            --accent-color: #666666;
            --meta-color: #888888;
            
            /* 毛玻璃变量 */
            --glass-bg: rgba(255, 255, 255, 0.4);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-blur: blur(20px);
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            
            --orb-1: rgba(65, 105, 225, 0.6);
            --orb-2: rgba(138, 43, 226, 0.6);
            --chart-line: #000;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #0f0f11;
                --text-color: #ffffff;
                --accent-color: #a1a1a1;
                --meta-color: #666666;
                
                --glass-bg: rgba(20, 20, 22, 0.4);
                --glass-border: rgba(255, 255, 255, 0.08);
                --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
                
                --orb-1: rgba(52, 152, 219, 0.5);
                --orb-2: rgba(155, 89, 182, 0.5);
                --chart-line: #fff;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'SF Pro Display', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            transition: background-color 0.8s;
            position: relative;
        }

        /* 优化后的光球：降低不透明度，增加模糊 */
        .background {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(120px); /* 更强的模糊 */
            opacity: 0.25;       /* 降低亮度 */
            animation: float 25s infinite ease-in-out alternate;
        }
        .orb-1 { width: 60vw; height: 60vw; background: var(--orb-1); top: -10%; left: -10%; }
        .orb-2 { width: 50vw; height: 50vw; background: var(--orb-2); bottom: -10%; right: -10%; animation-delay: -5s; }

        @keyframes float {
            0% { transform: translate(0, 0); }
            100% { transform: translate(40px, 60px); }
        }

        main {
            width: 100%;
            max-width: 900px;
            padding: 4rem 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        h1 {
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--meta-color);
            margin-bottom: 1.5rem;
        }

        /* 状态胶囊 - 毛玻璃 */
        .status-badge {
            display: inline-block;
            padding: 0.6rem 2rem;
            border-radius: 50px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            box-shadow: var(--card-shadow);
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* 卡片容器 - 毛玻璃 */
        .glass-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            padding: 2rem;
            width: 100%;
            margin-bottom: 2rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
        }

        .metric-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .card-value {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(180deg, var(--text-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-variant-numeric: tabular-nums;
            line-height: 1.1;
        }
        
        .card-unit { font-size: 1rem; margin-left: 4px; opacity: 0.6; }
        .card-label { margin-top: 0.5rem; font-size: 0.9rem; color: var(--meta-color); }

        /* 图表部分 */
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .chart-title { font-size: 1rem; font-weight: 600; }
        .config-info { font-size: 0.8rem; color: var(--meta-color); }

        canvas { width: 100%; height: 280px; display: block; }

        .error-msg {
            background: rgba(255, 59, 48, 0.15);
            color: #ff453a;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
            display: none;
            backdrop-filter: blur(10px);
        }

    </style>
</head>
<body>
    <div class="background">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <main>
        <header>
            <h1>iDRAC7 Fan Control</h1>
            <div class="status-badge" id="mode-display">初始化...</div>
        </header>

        <div class="error-msg" id="error-display"></div>

        <div class="dashboard glass-card">
            <!-- 曲线温度 (Control) -->
            <div class="metric-item">
                <div class="card-value"><span id="t-curve">--</span><span class="card-unit">°C</span></div>
                <div class="card-label">曲线参照温度</div>
            </div>
            
            <!-- 安全温度 (Safe) -->
            <div class="metric-item">
                <div class="card-value"><span id="t-safe">--</span><span class="card-unit">°C</span></div>
                <div class="card-label">安全参照温度</div>
            </div>

            <!-- 风扇设定 -->
            <div class="metric-item">
                <div class="card-value"><span id="fan-set">--</span><span class="card-unit">%</span></div>
                <div class="card-label">设定转速</div>
            </div>
        </div>

        <div class="glass-card">
            <div class="chart-header">
                <div class="chart-title">调速策略可视化</div>
                <div class="config-info" id="config-summary">加载中...</div>
            </div>
            <canvas id="curveChart"></canvas>
        </div>
    </main>

    <script>
        const els = {
            tCurve: document.getElementById('t-curve'),
            tSafe: document.getElementById('t-safe'),
            fanSet: document.getElementById('fan-set'),
            mode: document.getElementById('mode-display'),
            config: document.getElementById('config-summary'),
            err: document.getElementById('error-display'),
            canvas: document.getElementById('curveChart')
        };

        function drawChart(rules, currentCurveTemp) {
            const ctx = els.canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = els.canvas.getBoundingClientRect();
            
            els.canvas.width = rect.width * dpr;
            els.canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            
            const w = rect.width;
            const h = rect.height;
            const pad = { top: 20, right: 20, bottom: 30, left: 35 };
            const graphW = w - pad.left - pad.right;
            const graphH = h - pad.top - pad.bottom;
            const lineColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-line').trim();
            const metaColor = getComputedStyle(document.documentElement).getPropertyValue('--meta-color').trim();

            ctx.clearRect(0, 0, w, h);

            const maxTemp = 60; 
            const maxSpeed = 100;

            const getX = (t) => pad.left + (t / maxTemp) * graphW;
            const getY = (s) => pad.top + graphH - (s / maxSpeed) * graphH;

            // 网格与刻度
            ctx.fillStyle = metaColor;
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            
            for(let i=0; i<=4; i++) {
                let val = i * 25;
                let y = getY(val);
                ctx.fillText(val + '%', pad.left - 8, y);
                
                ctx.beginPath();
                ctx.strokeStyle = metaColor;
                ctx.globalAlpha = 0.1;
                ctx.moveTo(pad.left, y);
                ctx.lineTo(w - pad.right, y);
                ctx.stroke();
            }
            ctx.globalAlpha = 1.0;

            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            for(let i=0; i<=6; i++) {
                let val = i * 10;
                let x = getX(val);
                ctx.fillText(val + '°', x, h - pad.bottom + 10);
            }

            if (!rules || rules.length === 0) return;

            // 绘制阶梯
            ctx.beginPath();
            ctx.strokeStyle = lineColor;
            ctx.lineWidth = 2.5;
            ctx.lineJoin = 'round';
            ctx.shadowColor = 'rgba(0,0,0,0.1)';
            ctx.shadowBlur = 10;

            let startX = getX(0);
            let startY = getY(rules[0].speed); 
            ctx.moveTo(startX, startY);

            rules.forEach((r, i) => {
                let x1 = getX(r.min_temp);
                let x2 = getX(r.max_temp);
                let y = getY(r.speed);

                if (i > 0) {
                    let prevRule = rules[i-1];
                    let prevY = getY(prevRule.speed);
                    ctx.lineTo(x1, prevY);
                    ctx.lineTo(x1, y);
                }
                ctx.lineTo(x2, y);
            });
            ctx.stroke();
            ctx.shadowBlur = 0;

            // 当前温度指示
            if (currentCurveTemp) {
                let cx = getX(currentCurveTemp);
                if(cx > pad.left && cx < w - pad.right) {
                    ctx.beginPath();
                    ctx.strokeStyle = lineColor;
                    ctx.setLineDash([4, 4]);
                    ctx.lineWidth = 1.5;
                    ctx.moveTo(cx, pad.top);
                    ctx.lineTo(cx, h - pad.bottom);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // 游标点
                    let targetSpeed = 20;
                    for(let r of rules) {
                        if(currentCurveTemp >= r.min_temp && currentCurveTemp <= r.max_temp) {
                            targetSpeed = r.speed;
                            break;
                        }
                    }
                    let cy = getY(targetSpeed);

                    ctx.beginPath();
                    ctx.fillStyle = lineColor;
                    ctx.arc(cx, cy, 5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // 增加白色描边增强对比
                    ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
        }

        async function update() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                
                els.tCurve.innerText = data.curve_temp;
                els.tSafe.innerText = data.safe_temp !== -999 ? data.safe_temp : "--";
                els.fanSet.innerText = data.fan_speed_pct > 0 ? data.fan_speed_pct : "Auto";
                els.config.innerText = data.config_summary;
                
                const isAuto = data.mode === "动态";
                els.mode.innerText = isAuto ? "自动安全托管" : "手动曲线控制";
                els.mode.style.color = isAuto ? "#34c759" : "inherit";

                if (data.last_error) {
                    els.err.style.display = 'block';
                    els.err.innerText = data.last_error;
                } else {
                    els.err.style.display = 'none';
                }

                drawChart(data.current_curve, data.curve_temp);
            } catch (e) {
                console.error(e);
                els.mode.innerText = "连接中断";
            }
        }

        setInterval(update, 3000);
        update();
        window.addEventListener('resize', update);
    </script>
</body>
</html>